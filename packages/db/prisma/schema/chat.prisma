model Chat {
  id        String    @id @default(cuid())
  title     String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
  isArchived Boolean  @default(false)
  isPinned  Boolean   @default(false)
  metadata Json?

  // AI Provider settings
  provider  AIProvider @default(CLAUDE)
  model     String     @default("claude-3-5-sonnet-20241022")

  // Chat forking
  parentId            String?
  parent              Chat?   @relation("ChatForks", fields: [parentId], references: [id], onDelete: SetNull)
  forks               Chat[]  @relation("ChatForks")
  forkedFromMessageId String? // Which message was this forked from

  // Context & Rules
  contextLinks    ChatContext[]  // All context items linked to this chat
  ruleLinks       ChatRule[]     // All rules linked to this chat
  
  // Sharing
  shares          ChatShare[]

  @@index([userId, createdAt])
  @@index([userId, isPinned])
  @@map("chat")
}

model Message {
  id         String      @id @default(cuid())
  content    String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  chatId     String
  chat       Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  role       MessageRole @default(user)
  toolInvocations Json?   // For AI SDK tool calls
  metadata Json?
  attachments Attachment[]
  
  // Usage tracking
  tokens     Int?        // Token count for this message
  cost       Float?      // Estimated cost in USD
  latency    Int?        // Response time in milliseconds
  
  // Track which context/rules were active when this message was sent
  contextUsed     ContextItem[]  @relation("MessageContext")
  rulesUsed       Rule[]         @relation("MessageRules")
  
  @@index([chatId, createdAt])
  @@map("message")
}

enum MessageRole {
  user
  assistant
  system
  tool
}

model Attachment {
  id            String         @id @default(cuid())
  messageId     String
  message       Message        @relation(fields: [messageId], references: [id], onDelete: Cascade)
  kind          AttachmentKind
  filename      String
  mimeType      String
  size          Int
  storageKey    String
  transcription String?
  metadata      Json?
  createdAt     DateTime       @default(now())

  @@index([messageId])
  @@map("attachment")
}

enum AttachmentKind {
  image
  document
}

// ============================================
// CHAT SHARING
// ============================================

model ChatShare {
  id        String    @id @default(cuid()) @map("_id")
  token     String    @unique @default(cuid()) // Share URL token
  
  isPublic  Boolean   @default(true)
  expiresAt DateTime? // Optional expiration
  
  createdAt DateTime  @default(now())
  
  chatId    String
  chat      Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  sharedById String
  sharedBy   User     @relation(fields: [sharedById], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@map("chat_share")
}

// ============================================
// AI PROVIDER ENUM
// ============================================

enum AIProvider {
  CLAUDE
  GEMINI
  OPENAI
}